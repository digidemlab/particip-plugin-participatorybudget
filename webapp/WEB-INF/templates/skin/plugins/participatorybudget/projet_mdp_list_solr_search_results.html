<div id="psoum-list-container">

	<#if campagneService?? > <#-- Class not instanciated when this page is indexed by SOLR. This test avoid a lot of message into logs. -->
		<#attempt>
			
			<#if campagneService.isBeforeBeginning( "SUBMIT" ) >
				<div id="prop-card">
					<div class="row">
						<div class="col-xs-12 col-sm-offset-2 col-sm-8">
							<br>
							<div class="alert alert-warning">
								<h3 class="text-center text-warning"> <i class="fa fa-warning"></i> Attention !</h3>
								<p class="text-center">La page des projets soumis au vote n'est pas ouverte.</p>
							</div>
						</div>
					</div>			
				</div>			
			<#else>
				<h2 class="visuallyhidden">Barre de recherche</h2>
				<#include "projet_search_solr_search_results.html">
			
				<div class="container">
			
					<h2 class="visuallyhidden">Liste des résultats de la recherche</h2>
					<div id="psoum-list" class="row">
			
						<#assign theme_class = "autre">
						
						<#-- On boucle sur les projets à afficher -->
						<#list results_list as result>
						
							<#assign id_document = "${(result.id?split('Lutece_')?last)?split('_')?first}">
							<#assign result_detail_idx = ((paginator.pageCurrent-1)*paginator.itemsPerPage)+1+result_index>
			
							<#-- on identifie la classe CSS relative au thème du projet en cours -->
							<#if result.dynamicFields.statut_project_text?? && result.dynamicFields.statut_project_text = "PERDANT">
								<#assign theme_class_bis = "perdant">
							<#else>
								<#assign theme_class_bis = "undefined">
							</#if>
							
							<#if result.dynamicFields?? && result.dynamicFields.thematique_text??>
								<#if result.dynamicFields.thematique_text = "Cadre de vie"><#assign theme_class = "cadre_vie">
								<#elseif result.dynamicFields.thematique_text = "Culture" || result.dynamicFields.thematique_text = "Culture et patrimoine"><#assign theme_class = "culture">
								<#elseif result.dynamicFields.thematique_text = "Economie et emploi"><#assign theme_class = "economie_emploi">
								<#elseif result.dynamicFields.thematique_text = "Économie, emploi et attractivité"><#assign theme_class = "economie_emploi">
								<#elseif result.dynamicFields.thematique_text = "Education et jeunesse"><#assign theme_class = "education">
								<#elseif result.dynamicFields.thematique_text = "Environnement" || result.dynamicFields.thematique_text = "Nature en ville"><#assign theme_class = "environnement">
								<#elseif result.dynamicFields.thematique_text = "Logement et habitat"><#assign theme_class = "logement">
								<#elseif result.dynamicFields.thematique_text = "Participation citoyenne"><#assign theme_class = "participation_citoyenne">
								<#elseif result.dynamicFields.thematique_text = "Prévention et sécurité"><#assign theme_class = "prevention_securite">
								<#elseif result.dynamicFields.thematique_text = "Propreté"><#assign theme_class = "proprete">
								<#elseif result.dynamicFields.thematique_text = "Santé"><#assign theme_class = "sante">
								<#elseif result.dynamicFields.thematique_text = "Solidarité" || result.dynamicFields.thematique_text = "Vivre ensemble" || result.dynamicFields.thematique_text = "Solidarité et cohésion sociale " || result.dynamicFields.thematique_text = "Solidarité et cohésion sociale"><#assign theme_class = "solidarite">
								<#elseif result.dynamicFields.thematique_text = "Sport"><#assign theme_class = "sport">
								<#elseif result.dynamicFields.thematique_text = "Transport et mobilité"><#assign theme_class = "transport">
								<#elseif result.dynamicFields.thematique_text = "Ville intelligente et numérique"><#assign theme_class = "ville_numerique">
								</#if>
							</#if>
							
							<div class="col-xs-12 col-sm-6 col-md-4 psoum-panel <#if theme_class_bis = 'perdant'>psoum-perdant</#if>">
							
								<a id="title-${id_document}" href="${result.url}" alt="${result.title}" title="${result.title}" onclick="_paq.push(['trackEvent', 'PROD - Psoum List', 'Click vignette', 'Voir fiche']);">
			
									<#-- Image et éventuel résultat du vote -->
									<#assign img_url = "images/local/skin/i_${theme_class}_1x2.png">
									<#if result.dynamicFields.image_text?has_content>
										<#assign img_url = result.dynamicFields.image_text?split("src=\"")[1]?split("\"")[0]>
									</#if>
									<div class="psoum-card-img" style="background-image:url(${img_url!})">
										<#if campagneService.isAfterBeginning( "RESULT" )>
											<#if result.dynamicFields.statut_project_text=="GAGNANT" || result.dynamicFields.statut_project_text=="SUIVI" >
												<p class="winner">Projet gagnant<br>avec ${result.dynamicFields.nombre_de_votes_long?string.number!''} votes</p>
											<#elseif result.dynamicFields.statut_project_text=="PERDANT">
												<p class="looser">${result.dynamicFields.nombre_de_votes_long?string.number!''} votes</p>
											</#if>
										</#if>
									</div>
				
									<#-- La classe 'print-theme-${theme_class}' utilisee lors de l'impression -->
									<div class="psoum-card print-theme-${theme_class} bordered-4px-theme-${theme_class}">
					
										<#-- Thématique -->
										<div class="psoum-card-theme bgcolor-theme-${theme_class} bgcolor-theme-${theme_class_bis}">
											<img src="images/local/skin/i2_${theme_class}.png"/>
											<span>${result.dynamicFields.thematique_text!"Sans thématique"}</span>
										</div>
					
										<#-- Localisation -->
										<div class="psoum-card-loc">
				
											<#if result.dynamicFields.statut_project_text?? && result.dynamicFields.statut_project_text = "PERDANT">
												<img src="images/local/skin/marker.png" class="img-responsive pull-left" alt="" title="">
											<#else>
												<img src="images/local/skin/marker-${theme_class}.png" class="img-responsive pull-left" alt="" title="">
											</#if>
				
											<div class="for-print">
												<#if result.dynamicFields.localisation_precise_address_text?has_content>
													${result.dynamicFields.localisation_precise_address_text?replace(", 750[0-2][0-9] (?i)PARIS(?-i)", "", "r")}
												<#else>
													${(result.dynamicFields.localisation_text!'')}
												</#if>
											</div>
				
											<div class="for-screen">${result.dynamicFields.localisation_text!''}
												
												<div class="psoum-card-loc-prec">
													<#if result.dynamicFields?? && result.dynamicFields.localisation_precise_address_text??>
														${result.dynamicFields.localisation_precise_address_text?replace(", 750[0-2][0-9] (?i)PARIS(?-i)", "", "r")}
													<#else>
														&nbsp;
													</#if>
												</div>
											</div>
										</div>
					
										<#-- Titre -->
										<div class="psoum-card-titre">
											<h3>
												<span class="color-theme-${theme_class_bis}"><#if result.dynamicFields.code_projet_long?has_content && result.dynamicFields.code_projet_long &gt; 0 >${result.dynamicFields.code_projet_long} - </#if>${result.title}</span>
											</h3>
										</div>
					
										<#if campagneService.isDuring("VOTE") && voteValidated= true >
											<div class="psoum-card-vote">
													<div class="vote-done">Vous avez d&eacute;j&agrave; vot&eacute; ! Merci de votre int&eacute;r&ecirc;t pour le Budget Participatif.</div>
											</div>
										<#elseif campagneService.isDuring("VOTE") && voteValidated= false && arrondissementVote= "notConnected" >
											<div class="psoum-card-vote">
													@Extender[${id_document},document,vote,{show:"all"}]@
											</div>
										<#elseif campagneService.isDuring("VOTE") && voteValidated= false && (arrondissementVote == result.dynamicFields.localisation_text || result.dynamicFields.localisation_text= "Tout Paris")>
											<div class="psoum-card-vote">
													@Extender[${id_document},document,vote,{show:"all"}]@
											</div>
										<#elseif campagneService.isDuring("VOTE") && voteValidated= false && arrondissementVote != result.dynamicFields.localisation_text>
											<div class="psoum-card-vote">
													<div class="novote">Vous ne pouvez pas voter pour ce projet car il n'est pas situ&eacute; dans votre arrondissement de vote.</div>
											</div>
										<#else>
											<div class="psoum-card-link">
												<span class="btn btn-14rem btn-black-on-white">
													découvrir le projet
												</span>
											</div>
										</#if>
					
										<#-- Pastilles et coût -->
										<div class="psoum-card-footer">
											<#if result.dynamicFields.pop_district_text?has_content>
												<img src="images/local/skin/quartier-populaire.png" class="img-qp" alt="Projet en quartier populaire" title="Projet en quartier populaire" onclick="_paq.push(['trackEvent', 'PROD - Psoum List', 'Click vignette', 'Voir popover Q-Pop', 0]);">
											</#if>
											
											<#if result.dynamicFields.direction_text?? && result.dynamicFields.direction_text = "RATP">
												<img src="images/local/skin/ratp_color.png" class="img-ratp" alt="Projet RATP" title="Projet RATP" onclick="_paq.push(['trackEvent', 'PROD - Psoum List', 'Click vignette', 'Voir popover RATP', 0]);">
											</#if>
											
											<div class="budget pull-right">
												<img src="images/local/skin/money-${theme_class}.png" width="25px" height="25px" alt="" title="">
												<#if result.dynamicFields??>
													<#if result.dynamicFields.budget_long?? && result.dynamicFields.budget_long &gt; 0>
														<#setting locale="fr_FR">
														${result.dynamicFields.budget_long?string("#,###")} &#8364;
													<#else>
														${result.dynamicFields.budget_text!""}
													</#if>
												<#else>
													-
												</#if>
											</div>
											
										</div>
										
										<#-- Champs cachés pouvant être utilisés pour l'impression -->
										<div class="psoum-card-origin"><#if result.dynamicFields.pseudos_text?has_content>${result.dynamicFields.pseudos_text}</#if></div>
										
										<div class="psoum-card-description">${result.dynamicFields.description_text!""}</div>
										
										<#-- Champs transmis en Ajax lors du vote. Encore utilise au 05/05/2017 ? -->
										<input type="hidden" name="localisation_${id_document}" id="localisation_${id_document}" value="${result.dynamicFields.localisation_text!}">
										<input type="hidden" name="title_${id_document}" id="title_${id_document}" value="${result.title}">
										<input type="hidden" name="thematique_${id_document}" id="thematique_${id_document}" value="${result.dynamicFields.thematique_text}">
										<input type="hidden" name="arrondUser" id="arrondUser" value="${arrondissementVote!}">
					
									</div>
									
									<#--
									@Extender[${id_document},document,follow,{show:"favtag"}]@
									-->
									
								</a>
										
							</div>
									
						</#list>
					
					</div>
					
					<div id="paginator" class="solr-paginator">
						<@paginationSolr paginator=paginator />
					</div>
				</div>

			</#if>
		<#recover>
		</#attempt>
	</#if>

</div>

<#-- Freemarker macros -->

<#function min a b>
	<#if a gt b>
		<#return b />
	<#else>
		<#return a />
	</#if>
</#function>

<#function max a b>
	<#if a gt b>
		<#return a />
	<#else>
		<#return b />
	</#if>
</#function>

<#-- Number of items per page selector - Combo Box implementation -->
<#macro NbItemsPerPageSelectorCombo nb_items_per_page>
    <select name="items_per_page">
        <#list [ "10" , "20" , "50" , "100" ] as nb>
            <#if nb_items_per_page = nb >
                <option selected="selected" value="${nb}">${nb}</option>
            <#else>
                <option value="${nb}">${nb}</option>
            </#if>
        </#list>
    </select>
</#macro>

<#-- Number of items per page selector - Radio List implementation -->
<#macro NbItemsPerPageSelectorRadioList nb_items_per_page>
    <#list [ 5 , 10 , 20 , 50 ] as nb>
		<#if nb = nb_items_per_page >
			<input value="${nb}" id="items_per_page${nb}" name="items_per_page" class="radio" type="radio" checked /><label for="items_per_page${nb}">${nb}</label>
		<#else>
			<input value="${nb}" id="items_per_page${nb}" name="items_per_page" class="radio" type="radio" /><label for="items_per_page${nb}">${nb}</label>
		</#if>
    </#list>
</#macro>

<#macro paginationSolr paginator >

	<#assign nbLinkPages = 5 />
	<#assign offsetPrev = 2 />
	<#assign offsetNext = 2 />
  
	<#if (paginator.pagesCount > 1) >
	
		<#if paginator.pageCurrent &gt; nbLinkPages-offsetPrev >
			<a class="paginator-navi-page" href="${paginator.firstPageLink?xhtml}${monTri}" alt="Premi&egrave;re page" title="Premi&egrave;re page">
				<span class="show-xs"></span><i class="fa fa-angle-double-left"></i>
			</a>
		</#if>
		
		<#list paginator.pagesLinks as link>
			<#if ( link.index == paginator.pageCurrent )>
				<span class="paginator-current-page">${link.name}</span> <!-- <span class="paginator-sep-page">|</span> -->
			<#else>
				<#if (( link.index >= paginator.pageCurrent - offsetPrev ) && ( link.index <= paginator.pageCurrent + offsetNext )) >
					<a class="paginator-num-page" href="${link.url?xhtml}${monTri}" title="Aller à la page ${link.name}">${link.name}</a> <!-- <span class="paginator-sep-page">|</span> -->
				</#if>
			</#if>
		</#list>
		
		<#if paginator.pageCurrent &lt; paginator.pagesCount - (nbLinkPages-offsetNext) + 1>
			<a class="paginator-navi-page" href="${paginator.lastPageLink?xhtml}${monTri}" title="Derni&egrave;re page">
				<span class="show-xs"></span><i class="fa fa-angle-double-right"></i>
			</a>
		</#if>
		
	</#if>
	
</#macro>